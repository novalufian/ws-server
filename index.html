<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Document</title>
</head>
<body>
    <h1 class="text-2xl text-red-900 text-black">Room : <strong></strong></h1>
    <p id="member"></p>
    <p class="mt-32 text-green-500" id="clientInfo"></p>
    <section class="h-80 w-40 bg-gray-300 mb-4" data-room="2344">
        <p>2344</p>
        <div class="room-count"></div>
    </section>
    <section class="h-80 w-40 bg-red-300 mb-4" data-room="berita-satu">
        <p>berita-satu</p>
        <div class="room-count"></div>
    </section>
    <section class="h-80 w-40 bg-blue-300 mb-4" data-room="coba romm">
        <p>coba romm</p>
        <div class="room-count"></div>
    </section>

    <script>
        // https://via.placeholder.com/20/8F43EE/8F43EE
        var urlParams = new URLSearchParams(window.location.search);
        var _roomName_ = urlParams.get("title")
        const socket = io("http://localhost:8080/", {
            reconnectionDelayMax: 10000,
        });

        socket.on("connect", sct => {
            _init_()
            console.log(socket.id)
            socket.emit("joinRoom", _roomName_, socket.id)
            var prevRoom = getCookie("isCurrentUrl")

            if( prevRoom!= _roomName_){
                setCookie("isCurrentUrl", _roomName_)
                socket.emit("leaveRoom", prevRoom)
            }

        });
 

        setTimeout(() => {
        }, 200);

        socket.on("memberCount", function (member) {
            document.querySelector("#member").textContent = `${member} orang sedang online `
        })

        socket.on("msgFromRoom", function(data){
            console.log(data)        
        })

        //global broadcast event 
        socket.on("broadcast", function (arg) {
            console.log(arg)
            document.querySelector("#clientInfo").textContent =`${arg} user connected on site`
        })

        socket.on("roomInfo", (roomCount, elIndex)=>{
            console.log("room info")
            var sections = document.querySelectorAll("section")
            sections[elIndex].querySelector(".room-count").textContent = roomCount
        })



        function _init_() {
            DOMRoomName()
            var sections = document.querySelectorAll("section")
            sections.forEach(function (el, indx) {
                getRoomInfo(el, indx)
            })
        }

        function getRoomInfo(elm, elIndex) {
            var elmRoom = elm.getAttribute("data-room")
            socket.emit("getRoomInfo", elIndex,elmRoom)
        }

        function DOMRoomName() {
            document.querySelector("h1 strong").textContent =_roomName_
        }

        function setCookie(name, value, daysToExpire) {
            document.cookie = name + "=" + value + ";" + "" + ";path=/";
        }

        function getCookie(name) {
            var cookieName = name + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var cookieArray = decodedCookie.split(';');

            for (var i = 0; i < cookieArray.length; i++) {
                var cookie = cookieArray[i];
                while (cookie.charAt(0) === ' ') {
                cookie = cookie.substring(1);
                }
                if (cookie.indexOf(cookieName) === 0) {
                return cookie.substring(cookieName.length, cookie.length);
                }
            }

            return null;
        }

    </script>
</body>
</html>